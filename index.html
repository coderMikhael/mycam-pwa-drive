<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyCam PWA Gallery</title>

  <!-- PWA manifest (must be in the same folder) -->
  <link rel="manifest" href="manifest.json" />

  <!-- ======================== INLINE CSS ======================== -->
  <style>
    /* Reset & full‚Äêheight layout */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      font-family: sans-serif;
      overflow: hidden;
    }
    #appContainer {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      background: #000;
    }

    /* Camera view (hidden until ‚ÄúClick Picture‚Äù) */
    #cameraView {
      display: none;
      position: relative;
      flex: 1;
      background: #000;
      justify-content: center;
      align-items: center;
    }
    #cameraVideo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #cameraControls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      box-sizing: border-box;
    }
    /* Large circular ‚ÄúCapture‚Äù button */
    #captureBtn {
      background: #fff;
      border: none;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    /* Gallery icon on bottom right */
    #galleryBtn {
      background: rgba(255,255,255,0.9);
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 8px;
      cursor: pointer;
      background-position: center;
      background-repeat: no-repeat;
      background-size: 60%;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg viewBox='0 0 24 24' fill='%23000' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 19h16V5H4v14zm2-2v-2h4v2H6zm0-4v-2h12v2H6zm0-4V7h12v2H6z'/%3E%3C/svg%3E");
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    #galleryBtn:focus { outline: none; }

    /* Gallery view (displayed when camera is not active) */
    #galleryView {
      flex: 1;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #selectArea {
      padding: 10px;
      background: #222;
      text-align: center;
    }
    #clickBtn {
      background: #444;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    #clickBtn:focus { outline: none; }
    #galleryContainer {
      flex: 1;
      overflow-y: auto;
      padding: 5px;
      background: #e1e1e1;
    }
    .date-header {
      margin: 10px 0 5px 10px;
      font-size: 1.2em;
      color: #333;
      text-align: left;
    }
    .gallery-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-bottom: 10px;
      padding: 0 5px;
    }
    .thumb-container {
      position: relative;
      overflow: hidden;
      border-radius: 4px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .thumb-container img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      cursor: pointer;
      filter: brightness(0.9);
      transition: filter 0.2s;
    }
    .thumb-container img:hover {
      filter: brightness(1);
    }

    /* Full-screen overlay */
    #fullscreenOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 1000;
    }
    #fsHeader {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 10px;
      box-sizing: border-box;
    }
    .fs-icon-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
    }
    .fs-icon-btn:focus { outline: none; }
    #fsInfo {
      font-size: 16px;
      text-align: center;
    }
    #fsImageContainer {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    #fsImage {
      max-width: 80%;
      max-height: 80%;
      touch-action: pan-y;
    }
  </style>
</head>

<body>
  <div id="appContainer">

    <!-- Camera View (hidden by default) -->
    <div id="cameraView">
      <video id="cameraVideo" autoplay playsinline></video>

      <!-- Hidden fallback file input -->
      <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="fileInput" name="files[]" accept="image/*" capture="environment" />
      </form>

      <!-- Camera Controls -->
      <div id="cameraControls">
        <!-- Gallery button on the left -->
        <button id="galleryBtn" title="Back to Gallery"></button>
        <!-- Capture centered -->
        <button id="captureBtn" title="Capture Photo">‚óè</button>
      </div>
    </div>

    <!-- Gallery View (visible initially) -->
    <div id="galleryView">
      <div id="selectArea">
        <button id="clickBtn">Click Picture</button>
      </div>
      <div id="galleryContainer">
        <!--
          Server must inject these Handlebars‚Äêstyle loops. For example, in Flask you do:

            sorted_dates = sorted(grouped_images_by_date.keys(), reverse=True)
            return render_template('index.html', sorted_dates=sorted_dates, grouped=grouped)

          Then Jinja will replace {{ date }} and {{ img.filename }} etc.

          If you‚Äôre not using a server‚Äêside renderer, you will need to fetch a JSON
          of images and build the DOM via JavaScript here. But this template assumes
          Flask‚Äêstyle rendering.
        -->
        {% for date in sorted_dates %}
          <h2 class="date-header">{{ date }}</h2>
          <div class="gallery-row">
            {% for img in grouped[date] %}
              <div class="thumb-container">
                <img
                  src="{{ url_for('get_image', filename=img.filename) }}"
                  data-filename="{{ img.filename }}"
                  data-size="{{ img.size }}"
                  data-timestamp="{{ img.timestamp_iso }}"
                  data-mime="{{ img.mime_type }}"
                  class="thumb-img"
                  alt="thumb"
                />
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Full-screen Overlay -->
    <div id="fullscreenOverlay">
      <div id="fsHeader">
        <button id="fsCloseBtn" class="fs-icon-btn" title="Close">‚úñÔ∏è</button>
        <span id="fsInfo"></span>
        <button id="fsDeleteBtn" class="fs-icon-btn" title="Delete">üóëÔ∏è</button>
        <button id="fsShareBtn" class="fs-icon-btn" title="Share">üì§</button>
      </div>
      <div id="fsImageContainer">
        <img id="fsImage" src="" alt="Full Screen" />
      </div>
    </div>

  </div>

  <!-- ======================== INLINE JS ======================== -->
  <script>
    // Keep global references
    let videoStream = null,
        thumbnails = [],
        currentIndex = 0;

    document.addEventListener('DOMContentLoaded', () => {
      // Grab all relevant elements
      const camView     = document.getElementById('cameraView');
      const galView     = document.getElementById('galleryView');
      const videoEl     = document.getElementById('cameraVideo');
      const capBtn      = document.getElementById('captureBtn');
      const galBtn      = document.getElementById('galleryBtn');
      const fileInput   = document.getElementById('fileInput');
      const uploadForm  = document.getElementById('uploadForm');
      const clickBtn    = document.getElementById('clickBtn');
      const fsOverlay   = document.getElementById('fullscreenOverlay');
      const fsCloseBtn  = document.getElementById('fsCloseBtn');
      const fsDeleteBtn = document.getElementById('fsDeleteBtn');
      const fsShareBtn  = document.getElementById('fsShareBtn');

      // Show gallery on load
      camView.style.display = 'none';
      galView.style.display = 'flex';

      // ‚ÄúClick Picture‚Äù => hide gallery, show camera, start preview
      clickBtn.addEventListener('click', () => {
        galView.style.display = 'none';
        camView.style.display = 'flex';
        startCamera();
      });

      // ‚ÄúBack to Gallery‚Äù from camera => stop camera, show gallery
      galBtn.addEventListener('click', () => {
        stopCamera();
        camView.style.display = 'none';
        galView.style.display = 'flex';
      });

      // Capture a photo via ImageCapture or fallback to canvas
      capBtn.addEventListener('click', () => {
        if (!videoStream) return;
        const track = videoStream.getVideoTracks()[0];
        const ic = new ImageCapture(track);
        ic.takePhoto()
          .then(blob => uploadBlob(blob))
          .catch(() => captureViaCanvas());
      });

      // If user picks a file via fallback, submit the form
      fileInput.addEventListener('change', () => {
        uploadForm.submit();
      });

      // Full‚Äêscreen close, delete, share handlers
      fsCloseBtn.addEventListener('click', closeFullScreen);
      fsDeleteBtn.addEventListener('click', deleteCurrent);
      fsShareBtn.addEventListener('click', shareCurrent);

      // Initialize gallery click handlers
      initGallery();

      // Load Google API
      gapi.load('client:auth2', initClient);
    });

    // ============== CAMERA FUNCTIONS ==============

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          videoStream = stream;
          document.getElementById('cameraVideo').srcObject = stream;
        })
        .catch(err => {
          console.error('Camera error:', err);
          alert('Cannot access camera. Please allow camera access and retry.');
        });
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    }

    function captureViaCanvas() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => uploadBlob(blob), 'image/jpeg', 0.9);
    }

    function uploadBlob(blob) {
      const formData = new FormData();
      formData.append('files[]', blob, 'capture.jpg');
      // Your Flask endpoint must be ‚Äú/upload‚Äù for this to work.
      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(() => {
        // After upload, switch back to gallery and reload the page
        stopCamera();
        document.getElementById('cameraView').style.display = 'none';
        document.getElementById('galleryView').style.display = 'flex';
        location.reload();
      })
      .catch(err => {
        console.error('Upload failed:', err);
        alert('Upload failed. Check console for details.');
      });
    }

    // ============== GALLERY FUNCTIONS ==============

    function initGallery() {
      thumbnails = Array.from(document.querySelectorAll('.thumb-container'));
      thumbnails.forEach((container, idx) => {
        const imgEl = container.querySelector('img.thumb-img');
        imgEl.addEventListener('click', () => openFullScreen(idx));
      });
    }

    function openFullScreen(idx) {
      currentIndex = idx;
      updateFullScreen();
      document.getElementById('fullscreenOverlay').style.display = 'flex';
    }

    function closeFullScreen() {
      document.getElementById('fullscreenOverlay').style.display = 'none';
    }

    function updateFullScreen() {
      const container = thumbnails[currentIndex];
      const imgEl = container.querySelector('img.thumb-img');
      const data = imgEl.dataset;
      document.getElementById('fsImage').src = imgEl.src;
      const dt = new Date(data.timestamp).toLocaleString();
      document.getElementById('fsInfo').textContent =
        `${data.filename} (${data.size} MB)  ${dt}`;
    }

    function deleteCurrent() {
      const container = thumbnails[currentIndex];
      const filename = container.querySelector('img.thumb-img').dataset.filename;
      fetch(`/delete/${filename}`, { method: 'POST' })
        .then(() => location.reload())
        .catch(err => console.error('Delete failed:', err));
    }

    function shareCurrent() {
      const container = thumbnails[currentIndex];
      const imgEl = container.querySelector('img.thumb-img');
      const url = imgEl.src;
      const filename = imgEl.dataset.filename;
      const mime = imgEl.dataset.mime;
      fetch(url)
        .then(res => res.blob())
        .then(blob => {
          const file = new File([blob], filename, { type: mime });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file] }).catch(console.error);
          } else {
            alert('Sharing not supported on this device/browser.');
          }
        });
    }

    // ============== GOOGLE DRIVE INITIALIZATION ==============

    // Replace this CLIENT_ID with your actual OAuth 2.0 Client ID from Google Cloud
    const CLIENT_ID = '313117379094-jejji0ctdqj4blsptkccgb63lgcaouee.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

    let folderId = null;

    function initClient() {
      console.log('initClient() called');
      gapi.client.init({
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        console.log('gapi.client.init succeeded');
        afterSignin();
      }).catch(err => {
        console.error('Drive client init failed:', err);
        alert('Google Drive initialization error.');
      });
    }

    function afterSignin() {
      console.log('afterSignin() running');
      ensureFolderExists().then(loadGalleryFromDrive);
    }

    // 1) Check if ‚ÄúMyCam PWA Photos‚Äù folder exists in Drive; if not, create it.
    function ensureFolderExists() {
      return gapi.client.drive.files.list({
        q: "mimeType='application/vnd.google-apps.folder' and name='MyCam PWA Photos' and trashed=false",
        fields: 'files(id, name)'
      }).then(res => {
        const files = res.result.files;
        if (files && files.length > 0) {
          folderId = files[0].id;
          console.log('Found existing folder ID =', folderId);
          return Promise.resolve();
        }
        // Otherwise, create the folder
        return gapi.client.drive.files.create({
          resource: {
            name: 'MyCam PWA Photos',
            mimeType: 'application/vnd.google-apps.folder'
          },
          fields: 'id'
        }).then(folderRes => {
          folderId = folderRes.result.id;
          console.log('Created new folder ID =', folderId);
        });
      });
    }

    // 2) List all files in that folder, group them by date, and let Flask render them.
    function loadGalleryFromDrive() {
      return gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        orderBy: 'createdTime desc',
        fields: 'files(id, name, mimeType, createdTime, size)'
      }).then(res => {
        console.log('Drive list response:', res.result.files);
        // The HTML template (Flask/Jinja) should have already rendered the thumbnails
        // using ‚Äúgrouped‚Äù data. If you‚Äôre not using server‚Äêside rendering, you would
        // dynamically build the DOM here instead.
      });
    }
  </script>

  <!-- Load Google API client LAST, because initClient() must exist first -->
  <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>
